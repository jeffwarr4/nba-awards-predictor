name: NBA MVP Weekly Refresh (Publish to Pages)

on:
  workflow_dispatch:
    inputs:
      use_seed_prior:
        description: "Force use of seed prior snapshot for this run (bootstrap Movers)"
        required: false
        default: "false"
  schedule:
    # Mondays 17:15 UTC (~9:15am Pacific in standard time)
    - cron: "15 17 * * 1"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: nba-mvp-weekly-pages
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # IMPORTANT: Do NOT call stats.nba.com here
      # Instead, require that a cached/current candidates CSV exists in the repo.
      - name: Verify cached input files exist (freshness gate)
        run: |
          set -euo pipefail
          ls -la data/processed/current/nba_mvp_current_candidates.csv
          ls -la data/processed/current/nba_team_standings.csv

          python - << 'PY'
          import os, datetime

          def check(path, max_age_days=10):
            mtime = datetime.datetime.fromtimestamp(os.path.getmtime(path), tz=datetime.timezone.utc)
            age_hours = (datetime.datetime.now(datetime.timezone.utc) - mtime).total_seconds() / 3600
            print(f"[INFO] {path} age_hours={age_hours:.1f}")
            if age_hours > max_age_days * 24:
              raise SystemExit(f"{path} is too old. Refresh locally and push.")

          check("data/processed/current/nba_mvp_current_candidates.csv")
          check("data/processed/current/nba_team_standings.csv")
          PY

      # Single deterministic "prior" step:
      # 1) Try Pages last published current -> prior
      # 2) Else seed file in repo -> prior (one-time bootstrap)
      # 3) Else fail loudly (no silent movers break)
      - name: Prepare web_prior_top10.csv (seed opt-in -> Pages -> fail)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/processed/outputs

          PRIOR_OUT="data/processed/outputs/web_prior_top10.csv"
          PAGES_URL="https://jeffwarr4.github.io/nba-awards-predictor/nba/mvp/web_current_top10.csv"
          SEED_IN="data/processed/seeds/mvp_prior_top10_seed.csv"

          USE_SEED="${{ github.event.inputs.use_seed_prior }}"
          echo "[INFO] use_seed_prior=${USE_SEED:-<empty>}"

          if [ "${USE_SEED:-false}" = "true" ]; then
          if [ -f "$SEED_IN" ]; then
            echo "[INFO] Forcing seed prior snapshot: $SEED_IN"
            cp "$SEED_IN" "$PRIOR_OUT"
          else
            echo "[ERROR] use_seed_prior=true but seed file missing: $SEED_IN"
            exit 1
          fi
          else
          echo "[INFO] Trying to download prior from Pages (last published current)..."
          if curl -L --fail --silent --show-error -o "$PRIOR_OUT" "$PAGES_URL"; then
            echo "[INFO] Prior loaded from Pages: $PAGES_URL"
          elif [ -f "$SEED_IN" ]; then
            echo "[WARN] Pages prior not found. Using seed file: $SEED_IN"
            cp "$SEED_IN" "$PRIOR_OUT"
          else
            echo "[ERROR] No prior available (Pages missing AND seed missing)."
            exit 1
          fi
          fi

          echo "[INFO] Prior preview:"
          head -n 12 "$PRIOR_OUT"


      - name: Run NBA MVP pipeline (from cached inputs)
        env:
          MVP_PRIOR_TOP10_PATH: data/processed/outputs/web_prior_top10.csv
          FAIL_ON_MISSING_PRIOR: "1"
          WRITE_LOCAL_PRIOR_SNAPSHOT: "0"
        run: |
          set -euo pipefail
          python -m src.model.build_rankings_ridge_np_v1
          python -m src.publish.build_canva_flat_nba

      - name: Verify outputs exist before publish_pages
        run: |
          set -euo pipefail
          ls -la data/processed/outputs
          test -f data/processed/outputs/canva_top5_flat.csv || (echo "MISSING canva_top5_flat.csv" && exit 1)
          test -f data/processed/outputs/canva_6_10_flat.csv || (echo "MISSING canva_6_10_flat.csv" && exit 1)

      - name: Publish outputs into docs/
        run: |
          set -euo pipefail
          python -m src.publish.publish_pages
          ls -la docs/nba/mvp

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
