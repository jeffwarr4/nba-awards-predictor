name: NBA MVP Weekly Refresh (Publish to Pages)

on:
  workflow_dispatch:
  schedule:
    # Mondays 17:15 UTC (~9:15am Pacific in standard time)
    - cron: "15 17 * * 1"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: nba-mvp-weekly-pages
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # IMPORTANT: Do NOT call stats.nba.com here
      # Instead, require that a cached/current candidates CSV exists in the repo.
      - name: Verify current candidates file exists (freshness gate)
        run: |
          ls -la data/processed/current/nba_mvp_current_candidates.csv
          python - << 'PY'
          import os, datetime
          p="data/processed/current/nba_mvp_current_candidates.csv"
          mtime=datetime.datetime.fromtimestamp(os.path.getmtime(p), tz=datetime.timezone.utc)
          age=(datetime.datetime.now(datetime.timezone.utc)-mtime).total_seconds()/3600
          print(f"[INFO] nba_mvp_current_candidates age_hours={age:.1f}")
          # allow up to 10 days before failing (tune as you like)
          if age > 24*10:
              raise SystemExit("nba_mvp_current_candidates is too old. Refresh locally and push.")
          PY

      - name: Verify cached input files exist (freshness gate)
        run: |
          ls -la data/processed/current/nba_mvp_current_candidates.csv
          ls -la data/processed/current/nba_team_standings.csv

          python - << 'PY'
          import os, datetime

          def check(path, max_age_days=10):
            mtime = datetime.datetime.fromtimestamp(os.path.getmtime(path), tz=datetime.timezone.utc)
            age_hours = (datetime.datetime.now(datetime.timezone.utc) - mtime).total_seconds() / 3600
            print(f"[INFO] {path} age_hours={age_hours:.1f}")
            if age_hours > max_age_days * 24:
              raise SystemExit(f"{path} is too old. Refresh locally and push.")

          check("data/processed/current/nba_mvp_current_candidates.csv")
          check("data/processed/current/nba_team_standings.csv")
          PY

      - name: Run NBA MVP pipeline (from cached inputs)
        run: |
          python -m src.model.build_rankings_ridge_np_v1


      - name: Publish outputs into docs/
        run: |
          python -m src.publish.publish_pages

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
