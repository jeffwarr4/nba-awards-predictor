name: NBA MVP Weekly Refresh (Publish to Pages)

on:
  workflow_dispatch:
  schedule:
    # Mondays 17:15 UTC (~9:15am Pacific in standard time)
    - cron: "15 17 * * 1"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: nba-mvp-weekly-pages
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
                
      - name: Fetch prior top10 from GitHub Pages (last published current)
        run: |
          mkdir -p data/processed/prior
          echo "[INFO] Downloading last published web_current_top10.csv as prior..."
          curl -L --fail -o data/processed/prior/web_prior_top10.csv \
            https://jeffwarr4.github.io/nba-awards-predictor/nba/mvp/web_current_top10.csv \
            || echo "[WARN] No prior found on Pages yet (first run)."


      # IMPORTANT: Do NOT call stats.nba.com here
      # Instead, require that a cached/current candidates CSV exists in the repo.
      - name: Verify cached input files exist (freshness gate)
        run: |
          ls -la data/processed/current/nba_mvp_current_candidates.csv
          ls -la data/processed/current/nba_team_standings.csv

          python - << 'PY'
          import os, datetime

          def check(path, max_age_days=10):
            mtime = datetime.datetime.fromtimestamp(os.path.getmtime(path), tz=datetime.timezone.utc)
            age_hours = (datetime.datetime.now(datetime.timezone.utc) - mtime).total_seconds() / 3600
            print(f"[INFO] {path} age_hours={age_hours:.1f}")
            if age_hours > max_age_days * 24:
              raise SystemExit(f"{path} is too old. Refresh locally and push.")

          check("data/processed/current/nba_mvp_current_candidates.csv")
          check("data/processed/current/nba_team_standings.csv")
          PY

      - name: Create prior Top10 for movers (seed -> Pages fallback)
        run: |
          mkdir -p data/processed/outputs
          if [ -f data/processed/outputs/seed_web_prior_top10.csv ]; then
            echo "[INFO] Using seed prior snapshot"
            cp data/processed/outputs/seed_web_prior_top10.csv data/processed/outputs/web_prior_top10.csv
          else
            echo "[INFO] Fetching prior from Pages"
            curl -L --fail \
              -o data/processed/outputs/web_prior_top10.csv \
              https://jeffwarr4.github.io/nba-awards-predictor/nba/mvp/web_current_top10.csv \
              || echo "[WARN] No prior found yet"
          fi
    
      - name: Run NBA MVP pipeline (from cached inputs)
        run: |
          python -m src.model.build_rankings_ridge_np_v1
          python -m src.publish.build_canva_flat_nba

      - name: Verify outputs exist before publish_pages
        run: |
          ls -la data/processed/outputs
          test -f data/processed/outputs/canva_top5_flat.csv || (echo "MISSING canva_top5_flat.csv" && exit 1)
          test -f data/processed/outputs/canva_6_10_flat.csv || (echo "MISSING canva_6_10_flat.csv" && exit 1)

      - name: Publish outputs into docs/
        run: |
          python -m src.publish.publish_pages
          ls -la docs/nba/mvp


      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

 
